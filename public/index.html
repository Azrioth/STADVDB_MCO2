<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steam Games Reviews</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        h1 {
            color: #333;
        }

        form {
            margin-bottom: 20px;
        }

        .game-details {
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .game-details h2 {
            margin-top: 0;
        }

        .game-details p {
            margin: 5px 0;
        }

        .game-details span {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Steam Games Reviews</h1>
    <h2>Concurrent Read Test</h2>
        <form id="concurrent-read-form">
            <label for="concurrent-AppID">Enter Game ID:</label>
            <input type="text" id="concurrent-AppID" name="AppID" required>
            <button type="submit">Run Concurrent Read Test</button>
        </form>
<!-- Results table for Concurrent Read -->
    <table id="concurrent-read-table" style="border-collapse: collapse; width: 100%; margin-top: 20px;">
        <thead>
            <tr>
                <th style="border: 1px solid #ddd; padding: 8px;">Node</th>
                <th style="border: 1px solid #ddd; padding: 8px;">AppID</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Game Name</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Release Date</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Price</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Metacritic URL</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Metacritic Score</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Reviews</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Positive Reviews</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Negative Reviews</th>
            </tr>
        </thead>
        <tbody id="concurrent-read-body">
        </tbody>
    
    </table>
    <hr>
    
<!-- get game details section -->
    <form id="game-form">
        <h2>View All Game Details</h2>
            <label for="AppID">Enter Game ID:</label>
            <input type="text" id="AppID" name="AppID" required>
            <button type="submit">Fetch Game</button>
    </form>
    <div id="game-details" class="game-details" style="display: none;">
        <h2>Game Details</h2>
            <p><span>Game ID:</span> <span id="game-id"></span></p>
            <p><span>Name:</span> <span id="game-name"></span></p>
            <p><span>Release Date:</span> <span id="release-date"></span></p>
            <p><span>Price:</span> <span id="price"></span></p>
            <p><span>Required Age:</span> <span id="required-age"></span></p>
            <p><span>Achievements:</span> <span id="achievements"></span></p>
            <p><span>Reviews:</span> <span id="reviews"></span></p>
            <p><span>Positive Reviews:</span> <span id="positive-reviews"></span></p>
            <p><span>Negative Reviews:</span> <span id="negative-reviews"></span></p>
            <p><span>Metacritic Score:</span> <span id="metacritic-score"></span></p>
            <p><span>Metacritic URL:</span> <a id="metacritic-url" href="#" target="_blank">Link</a></p>
        <br>
    </div>
    <hr>

<!-- update game section -->
    <form id="update-form">
        <input type="hidden" id="update-AppID" name="AppID">
    
        <label for="Reviews">Review:</label>
        <input type="text" id="Reviews" name="Reviews">
        <div>
            <br>
            <label for="review-type-field">Review Type:</label>
            <select id="review-type-field" name="ReviewType">
                <option value=""></option>
                <option value="Positive">Positive</option>
                <option value="Negative">Negative</option>
            </select>
        </div>
        <br>
        <label for="Metacritic_url">Metacritic URL:</label>
        <input type="text" id="Metacritic_url" name="Metacritic_url">
    
        <label for="Metacritic_score">Metacritic Score:</label>
        <input type="number" id="Metacritic_score" name="Metacritic_score">
    
        <label for="update-Release_date">Release Date:</label>
        <input type="date" id="update-Release_date" name="Release_date" required>
    
        <button type="submit">Update Game</button>
    </form>

<!-- insert new game section-->
    <h2>Add New Game</h2>
    <form id="add-game-form">
        <label for="add-AppID">Game ID:</label>
        <input type="text" id="add-AppID" name="AppID" required><br>
    
        <label for="add-Game_Name">Name:</label>
        <input type="text" id="add-Game_Name" name="Game_Name" required><br>
    
        <label for="add-Release_date">Release Date:</label>
        <input type="date" id="add-Release_date" name="Release_date" required><br>
    
        <label for="add-Price">Price:</label>
        <input type="number" step="0.01" id="add-Price" name="Price" required><br>
    
        <label for="add-Required_age">Required Age:</label>
        <input type="number" id="add-Required_age" name="Required_age"><br>
    
        <label for="add-Achievements">Achievements:</label>
        <input type="text" id="add-Achievements" name="Achievements"><br>
    
        <button type="submit">Add Game</button>
    </form>

<!-- delete specific field section -->
    <h2>Delete Review</h2>
    <form id="delete-form">
        <input type="hidden" id="delete-AppID" name="AppID">

        <label for="Field">Select Field to Delete:</label>
        <select id="Field" name="Field">
            <option value="Reviews">Reviews</option>
            <option value="Metacritic_score">Metacritic Score</option>
            <option value="Metacritic_url">Metacritic URL</option>
        </select>
        
        <button type="submit" id="delete-button">Delete Field</button>
    </form>
    <br><br>
    <h2> Text Based Report: Customer Satisfaction Throughout the Years</h2>
    <table id="text-based-report-head" style="border-collapse: collapse; width: 100%; margin-top: 20px;">
        <thead>
            <tr>
                <th style="border: 1px solid #ddd; padding: 8px;">Year</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Positive Reviews</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Negative Reviews</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Customer Satisfaction</th>
            </tr>
        </theadd>
        
        <tbody id="text-based-report-body">
        </tbody>
        
    </table>


<!-- scripts section -->
<script>
        //fetch game details
    document.getElementById('game-form').addEventListener('submit', async (e) => {
        e.preventDefault();
            const appID = document.getElementById('AppID').value;
            const res = await fetch('/get_game', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ AppID: appID })
            });
            const data = await res.json();

            if (data.error) {
                alert(data.error);
                document.getElementById('game-details').style.display = 'none';
                return;
            }

            //show game details
            document.getElementById('game-id').textContent = data.data.AppID || 'N/A';
            document.getElementById('game-name').textContent = data.data.Game_Name || 'N/A';
            document.getElementById('release-date').textContent = data.data.Release_date
                ? new Date(data.data.Release_date).toISOString().split('T')[0]
                : 'N/A';
            document.getElementById('price').textContent = `$${data.data.Price || 0}`;
            document.getElementById('required-age').textContent = data.data.Required_age || 'N/A';
            document.getElementById('achievements').textContent = data.data.Achievements || 'N/A';
            document.getElementById('reviews').textContent = data.data.Reviews || 'No reviews';
            document.getElementById('positive-reviews').textContent = data.data.Positive_reviews || 0;
            document.getElementById('negative-reviews').textContent = data.data.Negative_reviews || 0;
            document.getElementById('metacritic-score').textContent = data.data.Metacritic_score || 'N/A';
            document.getElementById('metacritic-url').href = data.data.Metacritic_url || '#';
            document.getElementById('metacritic-url').textContent = data.data.Metacritic_url ? 'View Metacritic' : 'No URL';

            //show update form. what shows up in game fetch also shows up here
            document.getElementById('update-AppID').value = data.data.AppID || '';
            document.getElementById('Reviews').value = data.data.Reviews || '';
            document.getElementById('review-type-field').value = '';
            document.getElementById('Metacritic_url').value = data.data.Metacritic_url || '';
            document.getElementById('Metacritic_score').value = data.data.Metacritic_score || '';
            document.getElementById('update-Release_date').value = data.data.Release_date
                ? new Date(data.data.Release_date).toISOString().split('T')[0]
                : '';
            document.getElementById('game-details').style.display = 'block';
        });

        
       //update game details
    document.getElementById('update-form').addEventListener('submit', async (e) => {
        e.preventDefault();

    //fetch form data
        const formData = new FormData(document.getElementById('update-form'));
        const jsonData = Object.fromEntries(formData.entries());

    // Check if the Release_date is valid
        if (!jsonData.Release_date) {
            alert('Release date is required to determine the target table.');
            return;
        }

    //parse Release_date as js Date object
        const [year, month, day] = jsonData.Release_date.split('-');
        const releaseDate = new Date(year, month - 1, day); // Month is 0-indexed

    //know target table based on the release date in master
        const targetTable = releaseDate.getFullYear() < 2010
            ? 'mco2_ddbms_under2010'
            : 'mco2_ddbms_after2010';

    //asign into the actual data the targettable from logic
        jsonData.targetTable = targetTable;

        try {
        //communicate post request
            const res = await fetch('/update_game', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(jsonData)
            });

        //give response to user
        const message = await res.text();
        alert(message);

        } catch (error) {
            console.error('Error updating game:', error);
            alert('Failed to update the game. Check the console for details.');
        }
});


    //add new game
    document.getElementById('add-game-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        //just complete the form
        const formData = new FormData(document.getElementById('add-game-form'));
        const jsonData = Object.fromEntries(formData.entries());

            const res = await fetch('/add_game', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(jsonData),
            });

            const message = await res.text();
            alert(message);

    //clears the form fields after submission to "reset"
            document.getElementById('add-game-form').reset();
        });


    //concurrent read form section
    document.getElementById('concurrent-read-form').addEventListener('submit', async (e) => {
        e.preventDefault(); // Prevent form reload

    //get app id via input field
        const AppID = document.getElementById('concurrent-AppID').value;

        try {
        //get data from backend using a fetch
            const res = await fetch(`/concurrent_read?AppID=${AppID}`);
            const data = await res.json();

        //get the body
            const tableBody = document.getElementById('concurrent-read-body');

        //clear existing rows
            tableBody.innerHTML = '';

        //populate tablebody with the details + 3 rows for 3 nodes
            Object.keys(data).forEach((node) => {
                const result = data[node];

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="border: 1px solid #ddd; padding: 8px;">${node}</td>
                    ${Array.isArray(result) && result.length > 0
                        ? `
                        <td style="border: 1px solid #ddd; padding: 8px;">${result[0].AppID}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${result[0].Game_Name}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${new Date(result[0].Release_date).toISOString().split('T')[0]}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">$${result[0].Price}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${result[0].Metacritic_url || 'No metacritic URL'}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${result[0].Metacritic_score || 0}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${result[0].Reviews || 'No review'}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${result[0].Positive_reviews || 0}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${result[0].Negative_reviews || 0}</td>
                    `
                        : `
                        <td colspan="8" style="border: 1px solid #ddd; padding: 8px; text-align: center;">${result || 'No Data Found'}</td>
                        `}
                `;
                tableBody.appendChild(row);
            });
        } catch (error) {
            console.error('Error fetching concurrent read data:', error);
            alert('Failed to fetch data. Check the console for more details.');
        }
    });

    //delete field section
    document.getElementById('delete-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(document.getElementById('delete-form'));
        const jsonData = Object.fromEntries(formData.entries());
            

        const [year, month, day] = jsonData.Release_date.split('-');
        const releaseDate = new Date(year, month-1, day);

        const targetTable = releaseDate.getFullYear() < 2010
            ? 'mco2_ddbms_under2010'
            : 'mco2_ddbms_after2010';

        jsonData.targetTable = targetTable
            
        try{
            const res = await fetch('/delete_field', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(jsonData)
            });
        } catch (error){
            console.error('Error updating game:', error);
            alert('Failed to update the game. Check the console for details.');
            }

        });
    //text based report 
    async function fetchReviewSummary() {
        try {
            const response = await fetch('/fetch_reviews_summary');
            const data = await response.json();

            // Get the table body element
            const tableBody = document.getElementById('text-based-report-body');

            // Clear any existing rows in the table
            tableBody.innerHTML = '';

            // Populate the table with the data from the backend
            data.forEach(row => {
                const tr = document.createElement('tr');
                
                // Create table cells for each data field
                const yearCell = document.createElement('td');
                yearCell.textContent = row.Year;
                yearCell.style.border = '1px solid #ddd';
                yearCell.style.padding = '8px';
                tr.appendChild(yearCell);

                const positiveReviewsCell = document.createElement('td');
                positiveReviewsCell.textContent = row.Positive_reviews;
                positiveReviewsCell.style.border = '1px solid #ddd';
                positiveReviewsCell.style.padding = '8px';
                tr.appendChild(positiveReviewsCell);

                const negativeReviewsCell = document.createElement('td');
                negativeReviewsCell.textContent = row.Negative_reviews;
                negativeReviewsCell.style.border = '1px solid #ddd';
                negativeReviewsCell.style.padding = '8px';
                tr.appendChild(negativeReviewsCell);

                const customerSatisfactionCell = document.createElement('td');
                customerSatisfactionCell.textContent = row.Customer_satisfaction !== null ? row.Customer_satisfaction : 'N/A';
                customerSatisfactionCell.style.border = '1px solid #ddd';
                customerSatisfactionCell.style.padding = '8px';
                tr.appendChild(customerSatisfactionCell);

                //printing it out in tablebody
                tableBody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error fetching review summary:', error);
        }
    }

    //shows instantly into the window
    window.onload = fetchReviewSummary;

    </script>
</body>
</html>
